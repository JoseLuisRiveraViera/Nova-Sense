================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\app\(dashboard)\rivers\page.tsx
================================================================================
"use client";

import { useState, useEffect } from 'react';
import { InteractiveMap } from '@/components/map/InteractiveMap';
import { generateMockStations } from '@/lib/mockData';
import { Card, CardContent } from '@/components/ui/card';
import { MapPin, Droplets, AlertTriangle, RefreshCw } from 'lucide-react';
import type { Station } from '@/types';

export default function RiversPage() {
  const [stations, setStations] = useState<Station[]>([]);
  const [lastUpdate, setLastUpdate] = useState<Date>(new Date());

  // Function to update stations
  const updateStations = () => {
    const newStations = generateMockStations();
    setStations(newStations);
    setLastUpdate(new Date());
  };

  // Initial load
  useEffect(() => {
    updateStations();
  }, []);

  // Auto-refresh every hour (3600000 ms = 1 hour)
  useEffect(() => {
    const interval = setInterval(() => {
      updateStations();
    }, 3600000);

    return () => clearInterval(interval);
  }, []);

  const safeCount = stations.filter(s => s.quality === 'Buena').length;
  const cautionCount = stations.filter(s => s.quality === 'Moderada').length;
  const dangerCount = stations.filter(s => s.quality === 'Peligrosa').length;

  return (
    <div className="flex flex-1 flex-col">
      <div className="@container/main flex flex-1 flex-col gap-4">
        {/* Header */}
        <div className="px-4 lg:px-6 pt-4">
          <div className="flex flex-col gap-2">
            <div className="flex items-center gap-2">
              <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-600 to-blue-600 flex items-center justify-center">
                <MapPin className="w-6 h-6 text-white" aria-hidden />
              </div>
              <div className="flex-1">
                <h1 className="text-2xl md:text-3xl font-bold text-slate-900">
                  Mapa de Fuentes de Agua
                </h1>
                <div className="flex items-center gap-2 text-slate-600 text-sm">
                  <span>Explora el estado del agua en tiempo real en Nayarit</span>
                  <span className="hidden sm:inline">â€¢</span>
                  <div className="flex items-center gap-1 text-slate-500">
                    <RefreshCw className="w-3 h-3" aria-hidden />
                    <span className="text-xs">
                      Actualizado: {lastUpdate.toLocaleTimeString('es-MX', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                      })}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Quick Stats */}
        <div className="grid grid-cols-3 gap-3 px-4 lg:px-6" aria-label="Resumen por estado">
          <Card className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200">
            <CardContent className="p-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-green-700">{safeCount}</div>
                <div className="text-xs text-green-700 font-medium">Seguras</div>
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-200">
            <CardContent className="p-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-yellow-700">{cautionCount}</div>
                <div className="text-xs text-yellow-700 font-medium">PrecauciÃ³n</div>
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-red-50 to-rose-50 border-2 border-red-200">
            <CardContent className="p-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-red-700">{dangerCount}</div>
                <div className="text-xs text-red-700 font-medium">Peligrosas</div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Map */}
        <div className="flex-1 px-4 lg:px-6 pb-4">
          <div className="h-[calc(100vh-280px)] min-h-[500px]">
            {stations.length > 0 && <InteractiveMap stations={stations} />}
          </div>
        </div>

        {/* Info Cards */}
        <div className="grid md:grid-cols-2 gap-4 px-4 lg:px-6 pb-6">
          <div className="border-2 border-cyan-200 bg-gradient-to-br from-cyan-50 to-blue-50 rounded-lg">
            <div className="p-4">
              <div className="flex items-center gap-2 text-lg mb-2">
                <Droplets className="w-5 h-5 text-cyan-600" aria-hidden />
                <span className="font-semibold">CÃ³mo usar el mapa</span>
              </div>
              <ul className="space-y-2 text-sm text-slate-700">
                <li>ðŸ§­ <strong>Haz clic en los marcadores</strong> para ver detalles.</li>
                <li>ðŸ” <strong>Usa los controles</strong> (derecha) para navegar.</li>
                <li>ðŸ“ <strong>Encuentra tu ubicaciÃ³n</strong> con el botÃ³n de geolocalizaciÃ³n.</li>
                <li>ðŸŽ¯ <strong>Filtra fuentes</strong> por estado del agua.</li>
                <li>ðŸ–±ï¸ <strong>Usa la rueda del mouse</strong> para hacer zoom.</li>
                <li>ðŸ”„ <strong>ActualizaciÃ³n automÃ¡tica</strong> cada hora.</li>
              </ul>
            </div>
          </div>

          <div className="border-2 border-orange-200 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg">
            <div className="p-4">
              <div className="flex items-center gap-2 text-lg mb-2">
                <AlertTriangle className="w-5 h-5 text-orange-600" aria-hidden />
                <span className="font-semibold">Recomendaciones importantes</span>
              </div>
              <ul className="space-y-2 text-sm text-slate-700">
                <li>âœ… <strong>Agua verde:</strong> Segura al hervirla.</li>
                <li>âš ï¸ <strong>Agua amarilla:</strong> Ãšsala solo para riego.</li>
                <li>ðŸš« <strong>Agua roja:</strong> No la uses.</li>
                <li>ðŸ•’ <strong>Datos en tiempo real:</strong> actualizados cada hora.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\InteractiveMap.tsx
================================================================================
"use client";

import dynamic from 'next/dynamic';
import { useState, useEffect } from 'react';
import { Station } from '@/types';
import { Skeleton } from '@/components/ui/skeleton';
import { useMapSelection } from './useMapSelection';
import { StationDrawer } from './StationDrawer';

const LeafletMap = dynamic(
  () => import('./LeafletMap').then(mod => ({ default: mod.LeafletMap })),
  { ssr: false, loading: () => <MapSkeleton /> }
);

export type DisplayMode = 'popup' | 'panel' | 'bottomsheet';

interface InteractiveMapProps {
  stations: Station[];
}

function MapSkeleton() {
  return (
    <div className="relative w-full h-full bg-slate-100 rounded-xl border-2 border-slate-200 overflow-hidden" role="status" aria-live="polite">
      <Skeleton className="w-full h-full" />
      <div className="absolute top-6 right-6 space-y-2">
        <Skeleton className="w-10 h-10 rounded-md" />
        <Skeleton className="w-10 h-10 rounded-md" />
        <Skeleton className="w-10 h-10 rounded-md" />
        <Skeleton className="w-10 h-10 rounded-md" />
      </div>
      <div className="absolute bottom-6 left-6">
        <Skeleton className="w-56 h-44 rounded-lg" />
      </div>
      <div className="absolute top-6 left-6">
        <Skeleton className="w-28 h-10 rounded-md" />
      </div>
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="bg-white/90 backdrop-blur-sm px-8 py-4 rounded-lg shadow-xl border-2 border-cyan-200">
          <div className="flex items-center gap-3">
            <div className="w-5 h-5 border-4 border-cyan-600 border-t-transparent rounded-full animate-spin" aria-hidden />
            <p className="text-lg font-semibold text-slate-900">
              Cargando mapa de fuentes de aguaâ€¦
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

export function InteractiveMap({ stations }: InteractiveMapProps) {
  const { selectedStation, isOpen, selectStation, handleOpenChange } = useMapSelection();
  const [isMobile, setIsMobile] = useState(false);

  // Detect if mobile on mount
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Auto-responsive: popup on desktop, drawer on mobile
  const displayMode: DisplayMode = isMobile ? 'bottomsheet' : 'popup';

  return (
    <>
      <LeafletMap
        stations={stations}
        displayMode={displayMode}
        onStationSelect={displayMode === 'bottomsheet' ? selectStation : undefined}
        hideControls={isMobile && isOpen}
      />
      
      {/* Only render drawer on mobile */}
      {isMobile && (
        <StationDrawer
          station={selectedStation}
          open={isOpen}
          onOpenChange={handleOpenChange}
        />
      )}
    </>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\LeafletMap.tsx
================================================================================
"use client";

import { useMemo, useState, useCallback, useEffect } from 'react';
import { MapContainer, TileLayer, CircleMarker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { Station, WaterQuality } from '@/types';
import { StationCard } from './StationCard';
import { MapControls } from './MapControls';
import { MapLegend } from './MapLegend';
import { MapFilters, FilterState } from './MapFilters';
import type { DisplayMode } from './InteractiveMap';

// Fix Leaflet icons in Next.js
delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
});

interface LeafletMapProps {
  stations: Station[];
  displayMode?: DisplayMode;
  onStationSelect?: (station: Station | null) => void;
  hideControls?: boolean;
}

// Component to expose map instance
function MapController({ 
  onMapReady 
}: { 
  onMapReady: (map: L.Map) => void 
}) {
  const map = useMap();
  
  useEffect(() => {
    onMapReady(map);
  }, [map, onMapReady]);

  return null;
}

// Get color by quality
function getQualityColor(quality: WaterQuality): string {
  switch (quality) {
    case 'Buena':
      return '#10B981'; // emerald-500
    case 'Moderada':
      return '#F59E0B'; // yellow-500
    case 'Peligrosa':
      return '#EF4444'; // red-500
  }
}

export function LeafletMap({ 
  stations, 
  displayMode = 'popup', 
  onStationSelect,
  hideControls = false 
}: LeafletMapProps) {
  const [filteredStations, setFilteredStations] = useState<Station[]>(stations);
  const [map, setMap] = useState<L.Map | null>(null);
  const [isFilterOpen, setIsFilterOpen] = useState(false);

  const handleFilterChange = useCallback((filters: FilterState) => {
    const filtered = stations.filter(station => {
      const q = filters.qualities.has(station.quality);
      const t = !station.trend || filters.trends.has(station.trend);
      return q && t;
    });
    setFilteredStations(filtered);
  }, [stations]);

  const counts = useMemo(() => ({
    Buena: filteredStations.filter(s => s.quality === 'Buena').length,
    Moderada: filteredStations.filter(s => s.quality === 'Moderada').length,
    Peligrosa: filteredStations.filter(s => s.quality === 'Peligrosa').length,
  }), [filteredStations]);

  const handleMarkerClick = useCallback((station: Station) => {
    if (displayMode !== 'popup' && onStationSelect) {
      onStationSelect(station);
    }
  }, [displayMode, onStationSelect]);

  // Control handlers
  const handleZoomIn = () => map?.zoomIn();
  const handleZoomOut = () => map?.zoomOut();
  const handleLocate = () => map?.locate({ setView: true, maxZoom: 13 });
  const handleReset = () => map?.setView([21.5, -104.9], 9);

  return (
    <div className="relative w-full h-full">
      <MapContainer
        id="rivers-map"
        center={[21.5, -104.9]}
        zoom={9}
        scrollWheelZoom={true}
        className="w-full h-full rounded-xl border-2 border-slate-200 shadow-lg z-0"
        style={{ background: '#f1f5f9' }}
        aria-label="Mapa de fuentes de agua"
      >
        <MapController onMapReady={setMap} />
        
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          className="map-tiles"
        />

        {filteredStations.map((station) => {
          const position: [number, number] = [station.coordinates[0], station.coordinates[1]];
          const color = getQualityColor(station.quality);

          return (
            <CircleMarker
              key={station.id}
              center={position}
              radius={10}
              pathOptions={{
                fillColor: color,
                fillOpacity: 0.8,
                color: '#fff',
                weight: 3,
              }}
              eventHandlers={{
                click: () => handleMarkerClick(station),
              }}
            >
              {displayMode === 'popup' && (
                <Popup
                  maxWidth={300}
                  minWidth={280}
                  autoPan={true}
                  autoPanPadding={[50, 50]}
                  closeButton={true}
                  className="station-popup"
                >
                  <StationCard station={station} />
                </Popup>
              )}
            </CircleMarker>
          );
        })}
      </MapContainer>

      {/* Map Controls - Hidden when drawer is open on mobile */}
      {!hideControls && (
        <div className="absolute top-4 right-4 z-[500]">
          <MapControls
            onZoomIn={handleZoomIn}
            onZoomOut={handleZoomOut}
            onLocate={handleLocate}
            onReset={handleReset}
          />
        </div>
      )}

      {/* Filters - Hidden when drawer is open on mobile */}
      {!hideControls && (
        <div className={`absolute top-4 left-4 max-w-[90vw] sm:max-w-none ${isFilterOpen ? 'z-[600]' : 'z-[500]'}`}>
          <MapFilters 
            onChange={handleFilterChange}
            onOpenChange={setIsFilterOpen}
          />
        </div>
      )}

      {/* Legend - Hidden when drawer is open on mobile */}
      {!hideControls && (
        <div className="absolute bottom-16 left-4 z-[500]">
          <MapLegend counts={counts} />
        </div>
      )}

      {/* Count Badge - Hidden when drawer is open on mobile */}
      {!hideControls && (
        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 z-[500]">
          <div
            className="bg-white/95 backdrop-blur-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg shadow-lg border-2 border-cyan-200"
            role="status"
            aria-live="polite"
            aria-atomic="true"
          >
            <p className="text-xs sm:text-sm font-semibold text-slate-900 whitespace-nowrap">
              Mostrando <span className="text-cyan-600">{filteredStations.length}</span> de{' '}
              <span className="text-cyan-600">{stations.length}</span> fuentes
            </p>
          </div>
        </div>
      )}
    </div>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\MapControls.tsx
================================================================================
"use client";

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { ZoomIn, ZoomOut, Navigation, Maximize2 } from 'lucide-react';
import { cn } from '@/lib/utils';

interface MapControlsProps {
  onZoomIn?: () => void;
  onZoomOut?: () => void;
  onLocate?: () => void;
  onReset?: () => void;
  onFullscreen?: () => void;
  className?: string;
}

export function MapControls({
  onZoomIn,
  onZoomOut,
  onLocate,
  onReset,
  onFullscreen,
  className
}: MapControlsProps) {
  const [isFullscreen, setIsFullscreen] = useState(false);

  useEffect(() => {
    const handleFullscreenChange = () => {
      setIsFullscreen(!!document.fullscreenElement);
    };

    document.addEventListener('fullscreenchange', handleFullscreenChange);
    return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
  }, []);

  const handleFullscreenClick = () => {
    if (!document.fullscreenElement) {
      const mapContainer = document.getElementById('rivers-map')?.parentElement;
      mapContainer?.requestFullscreen();
      onFullscreen?.();
    } else {
      document.exitFullscreen();
    }
  };

  return (
    <div className={cn("flex flex-col gap-2", className)} role="group" aria-label="Controles del mapa">
      {/* Zoom Controls */}
      <div className="flex flex-col gap-1 bg-white rounded-lg shadow-lg border-2 border-slate-200 p-1">
        <Button
          variant="ghost"
          size="icon"
          onClick={onZoomIn}
          className="h-9 w-9 hover:bg-cyan-50 hover:text-cyan-700"
          aria-label="Acercar mapa"
        >
          <ZoomIn className="h-4 w-4" />
        </Button>
        
        <div className="h-px bg-slate-200 mx-1" />
        
        <Button
          variant="ghost"
          size="icon"
          onClick={onZoomOut}
          className="h-9 w-9 hover:bg-cyan-50 hover:text-cyan-700"
          aria-label="Alejar mapa"
        >
          <ZoomOut className="h-4 w-4" />
        </Button>
      </div>

      {/* Location & Reset */}
      <div className="flex flex-col gap-1 bg-white rounded-lg shadow-lg border-2 border-slate-200 p-1">
        <Button
          variant="ghost"
          size="icon"
          onClick={onLocate}
          className="h-9 w-9 hover:bg-cyan-50 hover:text-cyan-700"
          aria-label="Encontrar mi ubicaciÃ³n"
        >
          <Navigation className="h-4 w-4" />
        </Button>
        
        <div className="h-px bg-slate-200 mx-1" />
        
        <Button
          variant="ghost"
          size="icon"
          onClick={onReset}
          className="h-9 w-9 hover:bg-cyan-50 hover:text-cyan-700"
          aria-label="Restablecer vista"
        >
          <Maximize2 className="h-4 w-4" />
        </Button>
      </div>

      {/* Fullscreen */}
      {onFullscreen && (
        <div className="bg-white rounded-lg shadow-lg border-2 border-slate-200 p-1">
          <Button
            variant="ghost"
            size="icon"
            onClick={handleFullscreenClick}
            className={cn(
              "h-9 w-9 transition-colors",
              isFullscreen
                ? "bg-cyan-100 text-cyan-700 hover:bg-cyan-200"
                : "hover:bg-cyan-50 hover:text-cyan-700"
            )}
            aria-label={isFullscreen ? "Salir de pantalla completa" : "Pantalla completa"}
          >
            <Maximize2 className="h-4 w-4" />
          </Button>
        </div>
      )}
    </div>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\MapFilters.tsx
================================================================================
"use client";

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Filter, X } from 'lucide-react';
import { WaterQuality, WaterTrend } from '@/types';
import { cn } from '@/lib/utils';

export interface FilterState {
  qualities: Set<WaterQuality>;
  trends: Set<WaterTrend>;
}

interface MapFiltersProps {
  onChange: (filters: FilterState) => void;
  onOpenChange?: (open: boolean) => void;
}

const qualityOptions: { value: WaterQuality; label: string; color: string }[] = [
  { value: 'Buena', label: 'ðŸŸ¢ Segura', color: 'bg-emerald-500 hover:bg-emerald-600' },
  { value: 'Moderada', label: 'ðŸŸ¡ PrecauciÃ³n', color: 'bg-yellow-500 hover:bg-yellow-600' },
  { value: 'Peligrosa', label: 'ðŸ”´ Peligro', color: 'bg-red-500 hover:bg-red-600' },
];

const trendOptions: { value: WaterTrend; label: string }[] = [
  { value: 'improving', label: 'â†— Mejorando' },
  { value: 'stable', label: 'â†’ Estable' },
  { value: 'worsening', label: 'â†˜ Empeorando' },
];

export function MapFilters({ onChange, onOpenChange }: MapFiltersProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [selectedQualities, setSelectedQualities] = useState<Set<WaterQuality>>(
    new Set(['Buena', 'Moderada', 'Peligrosa'])
  );
  const [selectedTrends, setSelectedTrends] = useState<Set<WaterTrend>>(
    new Set(['improving', 'stable', 'worsening'])
  );

  useEffect(() => {
    onChange({
      qualities: selectedQualities,
      trends: selectedTrends,
    });
  }, [selectedQualities, selectedTrends, onChange]);

  // Notify parent when open state changes
  useEffect(() => {
    onOpenChange?.(isOpen);
  }, [isOpen, onOpenChange]);

  const toggleQuality = (quality: WaterQuality) => {
    setSelectedQualities(prev => {
      const next = new Set(prev);
      if (next.has(quality)) {
        if (next.size > 1) next.delete(quality);
      } else {
        next.add(quality);
      }
      return next;
    });
  };

  const toggleTrend = (trend: WaterTrend) => {
    setSelectedTrends(prev => {
      const next = new Set(prev);
      if (next.has(trend)) {
        if (next.size > 1) next.delete(trend);
      } else {
        next.add(trend);
      }
      return next;
    });
  };

  const resetFilters = () => {
    setSelectedQualities(new Set(['Buena', 'Moderada', 'Peligrosa']));
    setSelectedTrends(new Set(['improving', 'stable', 'worsening']));
  };

  const activeFiltersCount =
    (3 - selectedQualities.size) + (3 - selectedTrends.size);

  return (
    <div className="relative">
      {/* Toggle Button */}
      <Button
        variant="secondary"
        size="sm"
        onClick={() => setIsOpen(!isOpen)}
        className="bg-white/95 backdrop-blur-sm hover:bg-white shadow-lg border-2 border-slate-200"
        aria-label="Filtros de mapa"
        aria-expanded={isOpen}
      >
        <Filter className="w-4 h-4 mr-2" />
        Filtros
        {activeFiltersCount > 0 && (
          <span className="ml-2 px-1.5 py-0.5 text-xs bg-cyan-600 text-white rounded-full font-bold">
            {activeFiltersCount}
          </span>
        )}
      </Button>

      {/* Dropdown Panel */}
      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-[-1]"
            onClick={() => setIsOpen(false)}
            aria-hidden="true"
          />

          {/* Panel */}
          <Card className="absolute top-full mt-2 left-0 w-64 p-3 shadow-xl border-2 border-slate-200 bg-white">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-sm text-slate-900">Filtrar fuentes</h3>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setIsOpen(false)}
                className="h-6 w-6"
                aria-label="Cerrar filtros"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>

            {/* Quality Filters */}
            <div className="space-y-2 mb-3">
              <p className="text-xs font-semibold text-slate-600 uppercase tracking-wide">
                Estado del agua
              </p>
              <div className="flex flex-col gap-1.5">
                {qualityOptions.map(option => (
                  <Button
                    key={option.value}
                    variant={selectedQualities.has(option.value) ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => toggleQuality(option.value)}
                    className={cn(
                      "justify-start text-xs h-8",
                      selectedQualities.has(option.value)
                        ? `${option.color} text-white border-0`
                        : 'bg-slate-50 hover:bg-slate-100'
                    )}
                    aria-pressed={selectedQualities.has(option.value)}
                  >
                    {option.label}
                  </Button>
                ))}
              </div>
            </div>

            {/* Trend Filters */}
            <div className="space-y-2 mb-3">
              <p className="text-xs font-semibold text-slate-600 uppercase tracking-wide">
                Tendencia
              </p>
              <div className="flex flex-col gap-1.5">
                {trendOptions.map(option => (
                  <Button
                    key={option.value}
                    variant={selectedTrends.has(option.value) ? 'secondary' : 'outline'}
                    size="sm"
                    onClick={() => toggleTrend(option.value)}
                    className={cn(
                      "justify-start text-xs h-8",
                      selectedTrends.has(option.value)
                        ? 'bg-slate-200 hover:bg-slate-300'
                        : 'bg-slate-50 hover:bg-slate-100'
                    )}
                    aria-pressed={selectedTrends.has(option.value)}
                  >
                    {option.label}
                  </Button>
                ))}
              </div>
            </div>

            {/* Reset Button */}
            <Button
              variant="outline"
              size="sm"
              onClick={resetFilters}
              className="w-full text-xs border-cyan-600 text-cyan-700 hover:bg-cyan-50"
            >
              Restablecer filtros
            </Button>
          </Card>
        </>
      )}
    </div>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\MapLegend.tsx
================================================================================
"use client";

import { Card } from '@/components/ui/card';
import { WaterQuality } from '@/types';

interface MapLegendProps {
  counts: Record<WaterQuality, number>;
}

const legendItems: { quality: WaterQuality; label: string; color: string }[] = [
  { quality: 'Buena', label: 'Segura', color: 'bg-emerald-500' },
  { quality: 'Moderada', label: 'PrecauciÃ³n', color: 'bg-yellow-500' },
  { quality: 'Peligrosa', label: 'Peligro', color: 'bg-red-500' },
];

export function MapLegend({ counts }: MapLegendProps) {
  return (
    <Card className="bg-white/95 backdrop-blur-sm p-3 shadow-lg border-2 border-slate-200">
      <h3 className="text-xs font-bold text-slate-900 mb-2 uppercase tracking-wide">
        Leyenda
      </h3>
      <div className="space-y-1.5">
        {legendItems.map(item => (
          <div key={item.quality} className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <div
                className={`w-3 h-3 rounded-full ${item.color} shrink-0`}
                aria-hidden="true"
              />
              <span className="text-xs text-slate-700 font-medium">
                {item.label}
              </span>
            </div>
            <span className="text-xs font-bold text-slate-900 tabular-nums">
              {counts[item.quality]}
            </span>
          </div>
        ))}
      </div>
    </Card>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\StationCard.tsx
================================================================================
"use client";

import { Station } from '@/types';
import { Card } from '@/components/ui/card';
import { StationDetails } from './StationDetails';

interface StationCardProps {
  station: Station;
  onViewStats?: (id: string) => void;
}

export function StationCard({ station, onViewStats }: StationCardProps) {
  return (
    <Card className="border-0 shadow-none overflow-hidden">
      <StationDetails station={station} onViewStats={onViewStats} compact={true} />
    </Card>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\StationDetails.tsx
================================================================================
"use client";

import { Station } from '@/types';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { TrendingUp, TrendingDown, Minus, Droplets, ThermometerSun, TestTube, Activity } from 'lucide-react';
import Link from 'next/link';
import { cn } from '@/lib/utils';

interface StationDetailsProps {
  station: Station;
  onViewStats?: (id: string) => void;
  compact?: boolean;
}

const qualityConfig = {
  Buena: {
    color: 'bg-emerald-500',
    textColor: 'text-emerald-700',
    bgLight: 'bg-emerald-50',
    borderColor: 'border-emerald-200',
    label: 'âœ“ Segura',
    emoji: 'ðŸ’§',
    message: 'Puede tratarse para consumo'
  },
  Moderada: {
    color: 'bg-yellow-500',
    textColor: 'text-yellow-700',
    bgLight: 'bg-yellow-50',
    borderColor: 'border-yellow-200',
    label: 'âš  PrecauciÃ³n',
    emoji: 'âš ï¸',
    message: 'Ãšsala solo para riego'
  },
  Peligrosa: {
    color: 'bg-red-500',
    textColor: 'text-red-700',
    bgLight: 'bg-red-50',
    borderColor: 'border-red-200',
    label: 'â¨¯ Peligrosa',
    emoji: 'ðŸš«',
    message: 'No la uses bajo ninguna circunstancia'
  }
};

const trendConfig = {
  improving: {
    icon: TrendingUp,
    color: 'text-emerald-600',
    label: 'Mejorando'
  },
  stable: {
    icon: Minus,
    color: 'text-slate-600',
    label: 'Estable'
  },
  worsening: {
    icon: TrendingDown,
    color: 'text-red-600',
    label: 'Empeorando'
  }
};

export function StationDetails({ station, onViewStats, compact = false }: StationDetailsProps) {
  const config = qualityConfig[station.quality];
  const TrendIcon = trendConfig[station.trend].icon;

  // Mock readings for display (en producciÃ³n vendrÃ­an de station.lastReading)
  const readings = {
    ph: 7.2,
    turbidity: 8.5,
    oxygen: 7.8,
    temperature: 22.5
  };

  return (
    <div className="flex flex-col gap-3">
      {/* Image Header */}
      {station.imageUrl && (
        <div className={cn(
          "relative w-full overflow-hidden rounded-t-lg",
          compact ? "h-14" : "h-20"
        )}>
          <img
            src={station.imageUrl}
            alt={`Vista de ${station.name}`}
            className="w-full h-full object-cover"
          />
          <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent" />
        </div>
      )}

      {/* Header Content */}
      <div className={cn("px-3", station.imageUrl && "-mt-1")}>
        <div className="flex items-start justify-between gap-2">
          <div className="flex-1 min-w-0">
            <h3 className={cn(
              "font-bold text-slate-900 truncate",
              compact ? "text-sm" : "text-base"
            )}>
              {station.name}
            </h3>
            <div className={cn(
              "flex items-center gap-1.5 mt-0.5",
              compact ? "text-xs" : "text-sm"
            )}>
              <span className="text-slate-600">{config.emoji}</span>
              <span className={cn("font-medium", config.textColor)}>
                {config.message}
              </span>
            </div>
          </div>
          <Badge
            variant="secondary"
            className={cn(
              config.color,
              "text-white font-semibold shrink-0",
              compact ? "text-xs px-2 py-0.5" : "text-sm px-2.5 py-1"
            )}
          >
            {config.label}
          </Badge>
        </div>

        {/* Description */}
        {!compact && station.description && (
          <p className="text-xs text-slate-600 mt-2 line-clamp-2">
            {station.description}
          </p>
        )}
      </div>

      {/* Indicators Grid */}
      <div className={cn(
        "grid grid-cols-2 gap-2 px-3",
        compact && "gap-1.5"
      )}>
        <div className={cn(
          "flex items-center gap-2 rounded-lg p-2 border",
          config.bgLight,
          config.borderColor
        )}>
          <TestTube className={cn(
            config.textColor,
            compact ? "w-3.5 h-3.5" : "w-4 h-4"
          )} aria-hidden />
          <div className="flex flex-col min-w-0">
            <span className={cn(
              "font-bold text-slate-900",
              compact ? "text-xs" : "text-sm"
            )}>
              {readings.ph.toFixed(1)}
            </span>
            <span className={cn(
              "text-slate-600 leading-none",
              compact ? "text-[10px]" : "text-xs"
            )}>
              pH
            </span>
          </div>
        </div>

        <div className={cn(
          "flex items-center gap-2 rounded-lg p-2 border",
          config.bgLight,
          config.borderColor
        )}>
          <Droplets className={cn(
            config.textColor,
            compact ? "w-3.5 h-3.5" : "w-4 h-4"
          )} aria-hidden />
          <div className="flex flex-col min-w-0">
            <span className={cn(
              "font-bold text-slate-900",
              compact ? "text-xs" : "text-sm"
            )}>
              {readings.turbidity.toFixed(1)}
            </span>
            <span className={cn(
              "text-slate-600 leading-none",
              compact ? "text-[10px]" : "text-xs"
            )}>
              NTU
            </span>
          </div>
        </div>

        <div className={cn(
          "flex items-center gap-2 rounded-lg p-2 border",
          config.bgLight,
          config.borderColor
        )}>
          <Activity className={cn(
            config.textColor,
            compact ? "w-3.5 h-3.5" : "w-4 h-4"
          )} aria-hidden />
          <div className="flex flex-col min-w-0">
            <span className={cn(
              "font-bold text-slate-900",
              compact ? "text-xs" : "text-sm"
            )}>
              {readings.oxygen.toFixed(1)}
            </span>
            <span className={cn(
              "text-slate-600 leading-none",
              compact ? "text-[10px]" : "text-xs"
            )}>
              Oâ‚‚ mg/L
            </span>
          </div>
        </div>

        <div className={cn(
          "flex items-center gap-2 rounded-lg p-2 border",
          config.bgLight,
          config.borderColor
        )}>
          <ThermometerSun className={cn(
            config.textColor,
            compact ? "w-3.5 h-3.5" : "w-4 h-4"
          )} aria-hidden />
          <div className="flex flex-col min-w-0">
            <span className={cn(
              "font-bold text-slate-900",
              compact ? "text-xs" : "text-sm"
            )}>
              {readings.temperature.toFixed(1)}
            </span>
            <span className={cn(
              "text-slate-600 leading-none",
              compact ? "text-[10px]" : "text-xs"
            )}>
              Â°C
            </span>
          </div>
        </div>
      </div>

      {/* Trend (only in non-compact mode) */}
      {!compact && (
        <div className="flex items-center gap-2 px-3">
          <TrendIcon className={cn("w-4 h-4", trendConfig[station.trend].color)} aria-hidden />
          <span className="text-xs text-slate-600">
            Tendencia: <span className="font-medium">{trendConfig[station.trend].label}</span>
          </span>
        </div>
      )}

      {/* CTA Button */}
      <div className="px-3 pb-2">
        <Button
          asChild
          variant="outline"
          size={compact ? "sm" : "default"}
          className="w-full border-2 border-cyan-600 text-cyan-700 hover:bg-cyan-50 hover:text-cyan-800 font-semibold"
        >
          <Link href={`/stats?station=${station.id}`}>
            Ver estadÃ­sticas completas
          </Link>
        </Button>
      </div>

      {/* Last updated */}
      <div className="px-3 pb-1">
        <p className="text-[10px] text-slate-500 text-center">
          Actualizado: {station.lastUpdated.toLocaleString('es-MX', {
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
          })}
        </p>
      </div>
    </div>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\StationDrawer.tsx
================================================================================
"use client";

import { Station } from '@/types';
import { Drawer, DrawerContent, DrawerHeader, DrawerTitle } from '@/components/ui/drawer';
import { ScrollArea } from '@/components/ui/scroll-area';
import { StationDetails } from './StationDetails';
import { MapPin } from 'lucide-react';

interface StationDrawerProps {
  station: Station | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function StationDrawer({ station, open, onOpenChange }: StationDrawerProps) {
  if (!station) return null;

  return (
    <Drawer open={open} onOpenChange={onOpenChange}>
      <DrawerContent
        className="max-h-[85vh] flex flex-col"
        aria-label={`Detalles de ${station.name}`}
      >
        {/* Handle */}
        <div className="mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-slate-300 mt-3" aria-hidden />

        {/* Header */}
        <DrawerHeader className="px-4 pt-3 pb-2 shrink-0">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-600 to-blue-600 flex items-center justify-center shrink-0">
              <MapPin className="w-4 h-4 text-white" aria-hidden />
            </div>
            <DrawerTitle className="text-base font-bold text-slate-900">
              InformaciÃ³n de la fuente
            </DrawerTitle>
          </div>
        </DrawerHeader>

        {/* Scrollable Content */}
        <ScrollArea className="flex-1 overflow-auto">
          <div className="pb-4">
            <StationDetails station={station} compact={false} />
          </div>
        </ScrollArea>
      </DrawerContent>
    </Drawer>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\StationPanel.tsx
================================================================================
"use client";

import { Station } from '@/types';
import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { ScrollArea } from '@/components/ui/scroll-area';
import { StationDetails } from './StationDetails';
import { MapPin, X } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface StationPanelProps {
  station: Station | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function StationPanel({ station, open, onOpenChange }: StationPanelProps) {
  if (!station) return null;

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent
        side="right"
        className="w-full sm:w-[420px] p-0 flex flex-col"
        aria-label={`Detalles de ${station.name}`}
      >
        {/* Header */}
        <SheetHeader className="px-4 py-3 border-b border-slate-200 shrink-0">
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-2 min-w-0">
              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-600 to-blue-600 flex items-center justify-center shrink-0">
                <MapPin className="w-4 h-4 text-white" aria-hidden />
              </div>
              <SheetTitle className="text-base font-bold text-slate-900 truncate">
                InformaciÃ³n de la fuente
              </SheetTitle>
            </div>
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8 shrink-0"
              onClick={() => onOpenChange(false)}
              aria-label="Cerrar panel"
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        </SheetHeader>

        {/* Scrollable Content */}
        <ScrollArea className="flex-1">
          <div className="py-2">
            <StationDetails station={station} compact={false} />
          </div>
        </ScrollArea>

        {/* Footer hint */}
        <div className="px-4 py-2 border-t border-slate-200 shrink-0">
          <p className="text-xs text-slate-500 text-center">
            Presiona <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded text-[10px] font-mono">Esc</kbd> para cerrar
          </p>
        </div>
      </SheetContent>
    </Sheet>
  );
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\components\map\useMapSelection.ts
================================================================================
"use client";

import { useState, useCallback } from 'react';
import { Station } from '@/types';

export function useMapSelection() {
  const [selectedStation, setSelectedStation] = useState<Station | null>(null);
  const [isOpen, setIsOpen] = useState(false);

  const selectStation = useCallback((station: Station | null) => {
    setSelectedStation(station);
    setIsOpen(!!station);
  }, []);

  const clearSelection = useCallback(() => {
    setSelectedStation(null);
    setIsOpen(false);
  }, []);

  const handleOpenChange = useCallback((open: boolean) => {
    setIsOpen(open);
    if (!open) {
      // Delay clearing selection to allow exit animation
      setTimeout(() => setSelectedStation(null), 150);
    }
  }, []);

  return {
    selectedStation,
    isOpen,
    selectStation,
    clearSelection,
    handleOpenChange
  };
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\lib\mapHelpers.ts
================================================================================
import L from 'leaflet';
import { WaterQuality } from '@/types';

/**
 * Creates custom marker icon based on water quality
 */
export function createCustomIcon(quality: WaterQuality): L.DivIcon {
  const config = {
    Buena: {
      color: '#10B981',
      emoji: 'ðŸ’§',
      size: 32
    },
    Moderada: {
      color: '#F59E0B',
      emoji: 'âš ï¸',
      size: 32
    },
    Peligrosa: {
      color: '#EF4444',
      emoji: 'ðŸš«',
      size: 32
    }
  };

  const { color, emoji, size } = config[quality];

  return L.divIcon({
    html: `
      <div style="
        width: ${size}px;
        height: ${size}px;
        background: ${color};
        border: 3px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: transform 0.2s ease;
      " class="custom-marker">
        ${emoji}
      </div>
    `,
    className: 'custom-marker-container',
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2]
  });
}

/**
 * Tile layer configuration for OpenStreetMap
 */
export const tileLayerConfig = {
  url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
};

/**
 * Default map configuration
 */
export const mapConfig = {
  center: [21.5, -104.9] as [number, number],
  zoom: 9,
  minZoom: 8,
  maxZoom: 18,
  scrollWheelZoom: false
};

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\lib\mockData.ts
================================================================================
// src/lib/mockData.ts
import { Station, Reading, Alert, WaterQuality, WaterTrend } from "@/types";

const stationsData: Omit<Station, "lastUpdated">[] = [
  {
    id: "1",
    name: "RÃ­o San Pedro",
    coordinates: [22.226102510029904, -105.00979212636152],
    quality: "Moderada",
    description: "Agua apta solo para riego.",
    imageUrl: "https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=800",
    trend: "stable"
  },
  {
    id: "2",
    name: "RÃ­o Mololoa",
    coordinates: [21.51585409995925, -104.88884195220137],
    quality: "Peligrosa",
    description: "Agua altamente contaminada, no debe ser usada.",
    imageUrl: "https://images.unsplash.com/photo-1473448912268-2022ce9509d8?w=800",
    trend: "worsening"
  },
  {
    id: "3",
    name: "Laguna de Mora",
    coordinates: [21.516758, -104.811909],
    quality: "Buena",
    description: "Agua en Ã³ptimas condiciones.",
    imageUrl: "https://images.unsplash.com/photo-1439066615861-d1af74d74000?w=800",
    trend: "improving"
  },
  {
    id: "4",
    name: "Cascada el Cora",
    coordinates: [21.414812193928924, -105.12698881963927],
    quality: "Buena",
    description: "Agua cristalina en Ã³ptimas condiciones.",
    imageUrl: "https://images.unsplash.com/photo-1508167728150-326ba76d8297?w=800",
    trend: "stable"
  },
  {
    id: "5",
    name: "RÃ­o Huicicila",
    coordinates: [21.320345002104013, -105.055278545828],
    quality: "Buena",
    description: "Agua en excelente estado.",
    imageUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800",
    trend: "stable"
  },
  {
    id: "6",
    name: "Presa de Refilion",
    coordinates: [21.31053327955347, -104.89369957722249],
    quality: "Moderada",
    description: "Agua apta para riego.",
    imageUrl: "https://images.unsplash.com/photo-1433838552652-f9a46b332c40?w=800",
    trend: "stable"
  }
];

export function generateMockStations(): Station[] {
  return stationsData.map(station => ({
    ...station,
    lastUpdated: new Date(Date.now() - Math.random() * 3600000)
  }));
}

export function generateMockReadings(stationId: string, count: number = 24): Reading[] {
  const readings: Reading[] = [];
  const now = Date.now();
  
  for (let i = 0; i < count; i++) {
    const timestamp = new Date(now - (count - i) * 3600000);
    
    readings.push({
      id: `${stationId}-${i}`,
      stationId,
      timestamp,
      ph: 6.5 + Math.random() * 2,
      turbidity: Math.random() * 15,
      oxygen: 5 + Math.random() * 5,
      temperature: 18 + Math.random() * 8,
      wqi: 50 + Math.random() * 40
    });
  }
  
  return readings;
}

export function generateMockAlerts(): Alert[] {
  const stations = generateMockStations();
  const alerts: Alert[] = [];
  
  stations.forEach((station, idx) => {
    if (station.quality === "Peligrosa") {
      alerts.push({
        id: `alert-${idx}`,
        stationId: station.id,
        stationName: station.name,
        type: "critical",
        message: `Nivel crÃ­tico de contaminaciÃ³n detectado`,
        timestamp: new Date(Date.now() - Math.random() * 7200000),
        acknowledged: false
      });
    } else if (station.quality === "Moderada" && Math.random() > 0.5) {
      alerts.push({
        id: `alert-${idx}`,
        stationId: station.id,
        stationName: station.name,
        type: "warning",
        message: `Calidad del agua por debajo del nivel Ã³ptimo`,
        timestamp: new Date(Date.now() - Math.random() * 7200000),
        acknowledged: Math.random() > 0.7
      });
    }
  });
  
  return alerts;
}

export function getQualityColor(quality: WaterQuality): string {
  switch (quality) {
    case "Buena": return "hsl(142, 76%, 36%)";
    case "Moderada": return "hsl(38, 92%, 50%)";
    case "Peligrosa": return "hsl(0, 84%, 60%)";
  }
}

export function getQualityGradient(quality: WaterQuality): string {
  switch (quality) {
    case "Buena": return "from-green-500 to-emerald-600";
    case "Moderada": return "from-yellow-500 to-orange-500";
    case "Peligrosa": return "from-red-500 to-rose-600";
  }
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\lib\utils.ts
================================================================================
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\types\global.d.ts
================================================================================
declare module "*.css" {
  const content: { [className: string]: string };
  export default content;
}

declare module "*.scss" {
  const content: { [className: string]: string };
  export default content;
}

================================================================================
ARCHIVO: C:\Users\aimbo\OneDrive\Desktop\novasense\src\types\index.ts
================================================================================
// types/index.ts - Tipos globales del proyecto

export type WaterQuality = "Buena" | "Moderada" | "Peligrosa";

/**
 * Tendencia de la calidad del agua (agregar a tus tipos existentes)
 */
export type WaterTrend = 'improving' | 'stable' | 'worsening';

export interface Station {
  id: string;
  name: string;
  coordinates: [number, number]; // [latitude, longitude]
  quality: WaterQuality;
  description: string;
  imageUrl?: string;
  lastReading?: Reading;
  lastUpdated: Date;
  trend: WaterTrend;
}

export interface Reading {
  id: string;
  stationId: string;
  timestamp: Date;
  ph: number;
  turbidity: number; // NTU
  oxygen: number; // mg/L
  temperature: number; // Â°C
  wqi: number; // Water Quality Index (0-100)
}

export interface Alert {
  id: string;
  stationId: string;
  stationName: string;
  type: "critical" | "warning" | "info";
  message: string;
  timestamp: Date;
  acknowledged: boolean;
}

export interface DashboardStats {
  totalStations: number;
  goodQuality: number;
  moderateQuality: number;
  dangerousQuality: number;
  activeAlerts: number;
}

export interface ChartDataPoint {
  timestamp: string;
  ph: number;
  turbidity: number;
  oxygen: number;
  temperature: number;
}

